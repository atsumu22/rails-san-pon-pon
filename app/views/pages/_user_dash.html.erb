<div class="container dashboard py-5">

  <% if user_signed_in? %>
    <div class="dash-user mb-3">
      <h1>Welcome back, <%= current_user.name %> </h1>
      <%= link_to edit_user_path(current_user) do %>
        <p class="mb-2"><i class="fa fa-solid fa fa-pen-to-square me-1"></i>Edit profile</p>
      <% end %>
    </div>
  <% end %>

  <div class="dash-content">
    <div class="dash-rallies">
      <div class="rallies-container">
        <%# Check if the user has currently joined any stamp rally %>
        <% if current_user.participants.any?  %>
          <h6 class="mb-4">You are currently participating in
          <%= pluralize(current_user.participants.count, "stamp rally") %>
          </h6>
          <% current_user.participants.each do |participant| %>
          <%# *** declare this variable to keep code DRY ***%>
          <% @stamp_rally = participant.stamp_rally %>
          <% @shop_participants = @stamp_rally.shop_participants %>
          <% @stamp_card = StampCard.where(participant: participant, stamp_rally: @stamp_rally).first %>
            <div class="rally-card ongoing">
              <div>
                <h6><%= link_to @stamp_rally.name, stamp_rally_path(@stamp_rally), class: "rally-title" %></h6>
              </div>
              <div>
               <% shops_status = @stamp_card.shops_status %>
                 <p class="mb-0"><%= shops_status.select {|k, v| v == "stamped"}.length %> / <%= pluralize(@stamp_rally.shop_participants.count, "stamp") %> collected</p>
                <div class="links">
                  <%= link_to stamp_rally_participant_stamp_card_path(@stamp_rally, participant, @stamp_card), class: "small-button" do %>
                     <%= image_tag('icon-stamp.png') %> Stamps
                  <% end %>
                  <%= link_to map_view_stamp_rally_participant_stamp_card_path(@stamp_rally, participant, @stamp_card), class: "small-button" do %>
                    <i class="fa fa-solid fa fa-map me-2"></i> Map
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        <% else %>
          <p>You are not participating in any stamp rallies at the moment...</p>
          <p><%= link_to "Look for stamp rallies in your area!", stamp_rallies_path, class: "btn btn-primary" %></p>
        <% end %>
      </div>
    </div>
  </div>
</div>

<%# SCSS components in this file:
  _card_stamp_rally.scss


%>

<%# I am not very sure of how to add links...
stamp_rally_participant_stamp_card_path(participant.stamp_rally.id, @participant, participant.stamp_rally.stamp_card) %>
